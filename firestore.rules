rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can create/update their own profile
      allow create, update: if request.auth != null && request.auth.uid == userId;

      // Allow updating push token
      allow update: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['expoPushToken', 'pushTokenUpdatedAt']);
    }

    // Leaderboard collection
    match /leaderboard/{entryId} {
      // Anyone authenticated can read leaderboard
      allow read: if request.auth != null;

      // Users can create/update their own entries
      allow create: if request.auth != null
        && request.resource.data.documentId == request.auth.uid;
      allow update: if request.auth != null
        && resource.data.documentId == request.auth.uid;
    }

    // Challenges collection
    match /challenges/{challengeId} {
      // Anyone authenticated can read challenges (to join via code)
      allow read: if request.auth != null;

      // Users can create challenges
      allow create: if request.auth != null
        && request.resource.data.creatorId == request.auth.uid
        && request.resource.data.status == 'pending';

      // Creator can update their score
      allow update: if request.auth != null
        && request.auth.uid == resource.data.creatorId
        && request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['creatorScore', 'creatorCompletedAt']);

      // Challenger can join (update challenger fields)
      allow update: if request.auth != null
        && resource.data.status == 'pending'
        && resource.data.creatorId != request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['challengerId', 'challengerNickname', 'challengerPhotoURL', 'status'])
        && request.resource.data.status == 'accepted';

      // Challenger can update their score
      allow update: if request.auth != null
        && request.auth.uid == resource.data.challengerId
        && request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['challengerScore', 'challengerCompletedAt', 'status', 'completedAt']);

      // No direct deletes (Cloud Functions handle cleanup)
      allow delete: if false;
    }
  }
}
